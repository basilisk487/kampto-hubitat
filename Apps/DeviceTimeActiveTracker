/* Device Time On Tracker (Parent)
*  
*	2022 T. K. (kampto)
*	NOTES:  Track the time and counts a device is Active/On. Assign to a variable if needed. Refresh/Reset/Update variable various ways. Use variable in RM to trigger things. 
* 
*    Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with the License. You may obtain a copy of the License at
*    http://www.apache.org/licenses/LICENSE-2.0  Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
*    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.
*
*	Change Revision History:  
*	Ver		Date:		Who:		What:
* 	1.X.X	2023-4-12	kampto		Refernce Child App for revisions
* 	1.0.1	2022-10-02	kampto		First instance of Parent/Child apps. 
*/

def setVersion(){
    state.name = "Device Time Active Tracker"
	state.version = "1.X.X"
}

definition(
	name: "Device Time Active Tracker", namespace: "kampto", author: "T. K.",
	description: "Track the time a device or thing is active. Attach to a variable",
	category: "General",
	iconUrl: "",
	iconX2Url: "",
	iconX3Url: "",
    importUrl: "https://raw.githubusercontent.com/kampto/Hubitat/main/Apps/DeviceTimeActiveTracker",
    documentationLink: "https://community.hubitat.com/t/beta-device-active-time-tracker-app-device-on-timer-and-on-counter-with-variables-access/102896"
)

preferences { page(name: "Config") }

def Config() {
    dynamicPage(name: "", title: "", install: true, uninstall: true) {
		displayTitle()
    	installCheck()
		if(state.appInstalled == 'COMPLETE'){
			section("<b>Purpose & Instructions:</b>", hideable: true, hidden: true) {
			paragraph "Purpose: Track the time a device or thing is On, Open, Active. Link varibales to moniotr on dashboard or rule machine"
			paragraph "-Use this Parent App to install one or more child apps.<br>-Then configure the child app; select devices, name it, hit done." 	
            paragraph "-If you want to see the device On-time on dashoboard or as a device then first set up a variable in Settings/Hub Variables as String or Number and link to in the child app"
            }
			section("") {
				app(name: "anyOpenApp", appName: "Device Time Active Tracker Child", namespace: "kampto", title: "<b>Click to add a new 'Device Time Tracker' child</b>", multiple: true)
			}
  			
			section("") {
       		label title: "<b>Change name for parent app (optional)</b>", required: false
 			}
			
		}
	}
}

def installed() {
    log.debug "Installed with settings: ${settings}"
    initialize()
}

def updated() {
    log.debug "Updated with settings: ${settings}"
    unsubscribe()
    initialize()
}

def initialize() {
    log.info "There are ${childApps.size()} child apps"
    childApps.each {child ->
    log.info "Child app: ${child.label}"
    }
}

def installCheck(){  
    state.appInstalled = app.getInstallationState() 
	if(state.appInstalled != 'COMPLETE'){
		section{paragraph "Please hit 'Done' to install '${app.label}' parent app "}
  	}
  	else{
    	log.info "Parent Installed OK"
  	}
}

def getFormat(type, myText="") {		
    if(type == "title") return "<h3 style='color:#0000ff;font-weight: bold'>${myText}</h3>"
	if(type == "red") return "<style='color:#ff5349;'>${myText}"
	}

def displayTitle() {
    setVersion()
    theName = app.label
    if(theName == null || theName == "") theName = "New Child App"
	section (getFormat("title",  "App: ${state.name} - ${"ver " + state.version}")) {}
    }
